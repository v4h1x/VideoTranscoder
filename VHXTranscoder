#!/bin/bash
addr=$(echo ${CLUSTR} | egrep -o "[[:digit:]]{,3}" | head -n1)
addr=${addr}\.${ENC}\.${IN}\.
port=$(echo ${addr} | egrep -o "[[:digit:]]{1}\.[[:digit:]]{1}\.[[:digit:]]{1,2}\.")
port=${port//./}
info=$(VHXTranscoder -v quiet -v 32 -timeout 5000000 -f mpegts -i udp://${INPUT} 2>&1- )
dimension=$(echo $info | egrep -o '[0-9]{3,4}x[0-9]{3,4}' )
progressive=$(echo $info | grep -c progressive )
name=$(echo ${info//IRIB } | grep -o -P '(?<=service_name : ).*(?= service_provider:)' )
hevc=$(echo $info | grep -c hevc )
h264=$(echo $info | grep -c h264 )
mpeg2=$(echo $info | grep -c mpeg2video )
m10=$(echo $info | grep -c "Main 10" )
provider=IRIBCS

if [ $hevc == 1 ]
then
vf=hevc_cuvid
elif [ $h264 == 1 ]
then
vf=h264_cuvid
elif [ $mpeg2 == 1 ]
then
vf=mpeg2_cuvid
fi
if [ $m10 == 1 ]
then
cf=p010le && pix="format=pix_fmts=nv12,"
else
cf=nv12
fi
case "$progressive" in
	1)
	case "$FPS" in
		25)
		fps="fps=fps=25,"
		;;
	esac
	;;
	*)
	case "$FPS" in
		50)
		yadif="yadif_cuda=1:0:0,"
		;;
		*)
		yadif="yadif_cuda=0:0:0,"
		;;
	esac
	;;
esac

	
case "$dimension" in
	"1920x1080")
		case "$HEVC" in
			1)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=5[outv11][outv12][outp2][outp3][outp4];[outp2]scale_npp=w=1280:h=720:interp_algo=16,split=2[outv21][outv22];[outp3]scale_npp=w=768:h=432:interp_algo=16,split=2[outv31][outv32];[outp4]scale_npp=w=512:h=288:interp_algo=16,split=2[outv41][outv42]" -map "[outv11]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B1} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@1080p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}1:${port}1?pkt_size=1316 -map "[outv12]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B2} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@1080p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}2:${port}2?pkt_size=1316 -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv22]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B4} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}4:${port}4?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv32]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B6} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}6:${port}6?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316 -map "[outv42]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B8} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}8:${port}8?pkt_size=1316
			;;
			*)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=4[outv11][outp2][outp3][outp4];[outp2]scale_npp=w=1280:h=720:interp_algo=16[outv21];[outp3]scale_npp=w=768:h=432:interp_algo=16[outv31];[outp4]scale_npp=w=512:h=288:interp_algo=16[outv41]" -map "[outv11]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B1} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@1080p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}1:${port}1?pkt_size=1316 -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316
			;;
		esac
		;;
	
   "1280x720")
		case "$HEVC" in
			1)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=4[outv21][outv22][outp3][outp4];[outp3]scale_npp=w=768:h=432:interp_algo=16,split=2[outv31][outv32];[outp4]scale_npp=w=512:h=288:interp_algo=16,split=2[outv41][outv42]" -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv22]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B4} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}4:${port}4?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv32]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B6} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}6:${port}6?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316 -map "[outv42]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B8} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}8:${port}8?pkt_size=1316
			;;
			*)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=3[outv21][outp3][outp4];[outp3]scale_npp=w=768:h=432:interp_algo=16[outv31];[outp4]scale_npp=w=512:h=288:interp_algo=16[outv41]" -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@720p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316
			;;
		esac
		;;
		
  "720x576"|"704x576"|"544x576")
		case "$HEVC" in
			1)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=3[outp2][outp3][outp4];[outp2]scale_npp=w=1024:h=576:interp_algo=16,split=2[outv21][outv22];[outp3]scale_npp=w=768:h=432:interp_algo=16,split=2[outv31][outv32];[outp4]scale_npp=w=512:h=288:interp_algo=16,split=2[outv41][outv42]" -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@576p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv22]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B4} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@576p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}4:${port}4?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv32]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B6} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}6:${port}6?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316 -map "[outv42]" -map 0:a -c:v hevc_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 0 -bf:v $BFRAME -strict_gop 1 -b:v ${B8} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}8:${port}8?pkt_size=1316
			;;
			*)
			VHXTranscoder -v quiet -copyts -copytb 1 -timeout 1000000 -fifo_size 114688 -f mpegts -i udp://${INPUT} -c:v copy -c:a libfdk_aac -b:a 96k -sn -f mpegts -mpegts_copyts 1 - | VHXTranscoder -v quiet -xerror -copyts -copytb 1 -fflags genpts+discardcorrupt+nobuffer -flush_packets 1 -vsync 0 -hwaccel cuvid -hwaccel_device ${GPU} -c:v ${vf} -hwaccel_output_format ${cf} -f mpegts -i - -metadata title="${name}" -filter_complex "[0:v]${fps}${pix}hwupload_cuda=device=${GPU},${yadif}split=3[outp2][outp3][outp4];[outp2]scale_npp=w=1024:h=576:interp_algo=16[outv21];[outp3]scale_npp=w=768:h=432:interp_algo=16[outv31];[outp4]scale_npp=w=512:h=288:interp_algo=16[outv41]" -map "[outv21]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B3} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@576p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}3:${port}3?pkt_size=1316 -map "[outv31]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B5} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@432p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}5:${port}5?pkt_size=1316 -map "[outv41]" -map 0:a -c:v h264_nvenc -gpu ${GPU} -preset:v 5 -g 100 -spatial-aq 1 -aq-strength 8 -forced-idr 1 -profile:v 2 -bf:v $BFRAME -strict_gop 1 -b:v ${B7} -c:a copy -sn -aspect 16:9 -avioflags direct -fflags flush_packets  -f mpegts -mpegts_copyts 1 -metadata source="${INPUT}" -metadata service_provider="${provider}" -metadata service_name="${name}" -metadata title="${name}@288p" -metadata publisher="${provider}" -metadata:s:a:0 language=per -mpegts_flags +pat_pmt_at_frames -mpegts_start_pid 101 udp://${addr}7:${port}7?pkt_size=1316
			;;
		esac
		;;
		*)
			wall -n "Sorry, invalid input $INPUT"
			sleep 30
;;
esac




























label1(){
echo 'on siba'
VHX-RECORDER -v quiet -i rtmp://192.168.113.61/t1/test -c copy -f flv rtmp://192.168.113.61/live/x & P1=$!
kill -HUP $PID
wait $P1
echo 1 > /Downloads/loop
label2 & label3
}




checkname(){
echo 'check'
for %f in (*.mp4 *.avi *.mov) do 

#!/bin/bash
cd /Downloads/test
for n in *.inf; do echo "${n%.*}";
if [ ${n%.*} =! ${f%.*} ]
echo ${f%.*} "is not equal"
else echo ${f%.*} "is equal" ${f%.*}
done










ffmpeg -i "%f" -c:v libx264 -c:a aac "%~nf_new.mkv"
VHX-RECORDER -v quiet -i rtmp://192.168.113.61/t1/test -c copy -f flv rtmp://192.168.113.61/live/x & P1=$!
kill -HUP $PID
wait $P1
echo 1 > /Downloads/loop
label2 & label3
}














label2(){
echo 'on loop'
loop=1
while [ $loop == 1 ]; do
a=$(date +%s%N)
VHX-RECORDER -v quiet -i rtmp://192.168.113.61/t2/test -c copy -f flv rtmp://192.168.113.61/live/y & P2=$!
echo 'in label2 P2 is' $P2
echo $P2 > /Downloads/PID
wait $P2
sleep $c
b=$(date +%s%N)
z=$((b-a))
echo 'in label2 a is' $a
echo 'in label2 b is' $b
echo 'in label2 z is' $z 
z=0${z:0: -9}
echo 'in label2 z2 is' $z
if [ $z -gt 10 ]
then
c=0
echo 'c reseted'
fi
if [ $c -gt 7 ]
then
c=7
else
((c+=1))
echo 'c = ' $c
fi

loop=$(</Downloads/loop)
done
echo 'exit of label2'
}

label3(){
info=$(VHX-RECORDER -hide_banner -v 32 -f flv -i rtmp://192.168.113.61/t1/test 2>&1- )
on=$(echo $info | grep -c 'stream not found')
echo 'i am label3'
}

label1
while true; do
sleep 10
label3
if [ $on == 0 ]
then
PID=$(</Downloads/PID)
echo 'in ROOT P2 is' $PID
echo 0 > /Downloads/loop
label1
fi
done





